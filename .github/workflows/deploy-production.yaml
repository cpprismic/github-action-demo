name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (commit SHA)'
        required: true
        type: string
      confirm:
        description: 'Type "PRODUCTION" to confirm'
        required: true
        type: string

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/system-monitor

concurrency:
  group: production-deployment
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Validate confirmation
        id: validate
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "PRODUCTION" ]]; then
            echo "Error: You must type 'PRODUCTION' to confirm"
            exit 1
          fi
          
          # Проверяем формат SHA (опционально)
          if [[ ! "${{ github.event.inputs.version }}" =~ ^[a-f0-9]{40}$ && "${{ github.event.inputs.version }}" != "latest" ]]; then
            echo "Error: Version must be a valid commit SHA (40 chars) or 'latest'"
            exit 1
          fi
          
          echo "Validation passed"
          echo "valid=true" >> $GITHUB_OUTPUT

  check-ci-status:
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      commit: ${{ steps.check.outputs.commit }}
    steps:
      - name: Check CI status for this commit
        id: check
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # Если latest, получаем последний коммит из main
          if [[ "$VERSION" == "latest" ]]; then
            git clone --depth 50 https://github.com/${{ github.repository }}.git temp-repo
            cd temp-repo
            VERSION=$(git rev-parse origin/main)
            cd .. && rm -rf temp-repo
            echo "Using latest main commit: $VERSION"
          fi
          
          echo "Checking CI status for commit: $VERSION"
          
          # Проверяем статус CI
          CI_STATUS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/commits/$VERSION/check-runs" \
            | jq -r '.check_runs[] | select(.name | contains("CI")) | .conclusion' \
            | head -1)
          
          if [[ "$CI_STATUS" != "success" ]]; then
            echo "CI tests failed or not found! Cannot deploy to production."
            exit 1
          fi
          
          echo "CI tests passed for commit $VERSION"
          echo "commit=$VERSION" >> $GITHUB_OUTPUT

  deploy:
    needs: [validate, check-ci-status]
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://your-production-domain.com  # Замените на ваш домен
    
    steps:
    - name: Notify about deployment start
      run: |
        echo "PRODUCTION DEPLOYMENT STARTED"
        echo "Version: ${{ needs.check-ci-status.outputs.commit }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Time: $(date)"
    
    - name: Deploy to Production VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST_PROD }}
        username: ${{ secrets.VPS_USERNAME_PROD }}
        key: ${{ secrets.VPS_SSH_KEY_PROD }}
        script: |
          set -e  # Exit on error
          
          echo "PRODUCTION DEPLOYMENT"
          echo "Version: ${{ needs.check-ci-status.outputs.commit }}"
          
          # Создаем backup директорию
          BACKUP_DIR=~/system-monitor-backups/$(date +%Y%m%d_%H%M%S)
          mkdir -p $BACKUP_DIR
          
          cd ~/system-monitor || mkdir -p ~/system-monitor && cd ~/system-monitor
          
          # Backup текущей конфигурации если есть
          if [ -f docker-compose.yml ]; then
            cp docker-compose.yml $BACKUP_DIR/
            docker-compose ps > $BACKUP_DIR/containers.txt
          fi
          
          # Скачиваем актуальный docker-compose
          curl -o docker-compose.yml \
            https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml
          
          # Логинимся в Docker Hub
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          
          # Останавливаем старый контейнер
          docker-compose down || true
          
          # Обновляем образ
          export TAG=${{ needs.check-ci-status.outputs.commit }}
          docker-compose pull
          docker-compose up -d
          
          # Расширенная проверка здоровья
          echo "Waiting for service to be healthy..."
          sleep 10
          
          # Проверка через curl если есть health endpoint
          if curl -f http://localhost:8080/health 2>/dev/null; then
            echo "Health check passed!"
          else
            echo "Health check not available or failed, checking container status..."
          fi
          
          # Проверка статуса контейнеров
          if docker-compose ps | grep "Up"; then
            echo "Containers are running!"
            docker-compose ps
          else
            echo "Containers failed to start"
            docker-compose logs
            exit 1
          fi
          
          # Очистка старых образов
          docker image prune -f
          
          echo "PRODUCTION DEPLOYMENT COMPLETE!"
          
          # Сохраняем информацию о деплое
          cat > $BACKUP_DIR/deploy-info.txt << EOF
          Version: ${{ needs.check-ci-status.outputs.commit }}
          Deployed by: ${{ github.actor }}
          Date: $(date)
          Workflow: ${{ github.run_id }}
          EOF
    
    - name: Create GitHub Deployment
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: '${{ needs.check-ci-status.outputs.commit }}',
            environment: 'production',
            required_contexts: [],
            auto_merge: false
          });