name: Deploy to Development

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (commit SHA or "latest")'
        required: true
        default: 'latest'
        type: string

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/system-monitor

jobs:
  check-ci-status:
    runs-on: ubuntu-latest
    outputs:
      ci-passes: ${{ steps.check.outputs.passes }}
    steps:
      - name: Check CI status for this commit
        id: check
        run: |
          # Определяем версию для проверки
          VERSION="${{ github.event.inputs.version }}"
          if [[ "$VERSION" == "latest" ]]; then
            # Получаем последний коммит из main/develop
            git clone --depth 50 https://github.com/${{ github.repository }}.git temp-repo
            cd temp-repo
            VERSION=$(git rev-parse origin/develop)
            cd .. && rm -rf temp-repo
          fi
          
          echo "Checking CI status for commit: $VERSION"
          
          # Проверяем статус CI через GitHub API
          CI_STATUS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/commits/$VERSION/check-runs" \
            | jq -r '.check_runs[] | select(.name | contains("CI")) | .conclusion' \
            | head -1)
          
          echo "CI Status: $CI_STATUS"
          
          if [[ "$CI_STATUS" == "success" ]]; then
            echo "CI tests passed! Proceeding with deployment..."
            echo "passes=true" >> $GITHUB_OUTPUT
            echo "commit=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "CI tests failed or not found! Deployment blocked."
            echo "passes=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  deploy:
    needs: check-ci-status
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - name: Deploy to Development VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST_DEV }}
        username: ${{ secrets.VPS_USERNAME_DEV }}
        key: ${{ secrets.VPS_SSH_KEY_DEV }}
        script: |
          echo "Deploying to DEVELOPMENT..."
          echo "Version: ${{ needs.check-ci-status.outputs.commit }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Timestamp: $(date)"
          
          # Создаем директорию если нет
          mkdir -p ~/system-monitor
          cd ~/system-monitor
          
          # Скачиваем docker-compose.yml
          curl -o docker-compose.yml \
            https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml
          
          # Логинимся в Docker Hub
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          
          # Останавливаем старый контейнер
          docker-compose down || true
          
          # Обновляем образ
          export TAG=${{ needs.check-ci-status.outputs.commit }}
          docker-compose pull
          docker-compose up -d
          
          # Проверка здоровья
          sleep 5
          if docker-compose ps | grep "Up"; then
            echo "Container is running!"
          else
            echo "Container failed to start"
            docker-compose logs
            exit 1
          fi
          
          # Очистка
          docker image prune -f
          
          echo "Deployment to DEVELOPMENT complete!"